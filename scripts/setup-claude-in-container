#!/bin/bash
# Setup Claude Code environment in sandboxes/containers
# Run this on a fresh container to restore tools, skills, and plugins

set -e

# Detect if running in sandbox/container
is_sandbox() {
  [ -f "/.dockerenv" ] && return 0
  [ -f "/run/.containerenv" ] && return 0
  [ "$(uname -s)" = "Linux" ] && return 0
  [ "$(whoami)" = "agent" ] && return 0
  [ -f /proc/1/cgroup ] && grep -qE "(docker|lxc|kubepods|containerd)" /proc/1/cgroup 2>/dev/null && return 0
  return 1
}

if ! is_sandbox; then
  echo "Detected local Mac environment."
  echo "This script is for sandbox/container environments."
  read -p "Run anyway? (y/N) " -n 1 -r
  echo
  [[ ! $REPLY =~ ^[Yy]$ ]] && exit 0
fi

echo "Setting up Claude Code environment..."

# === Tools ===
echo "Installing bun..."
command -v bun &>/dev/null || curl -fsSL https://bun.sh/install | bash
export PATH="$HOME/.bun/bin:$PATH"

echo "Installing agent-browser..."
npm install -g agent-browser 2>/dev/null || true
agent-browser install 2>/dev/null || true

# === Skills ===
echo "Adding skills..."
npx skills add https://github.com/vercel-labs/agent-skills --skill vercel-react-best-practices
npx skills add https://github.com/vercel-labs/agent-browser --skill agent-browser

# === animations.dev licenses ===
echo "Activating animations.dev..."
ANIMATIONS_EMAIL="${ANIMATIONS_EMAIL:-smugeh@gmail.com}"
curl -fsSL "https://animations.dev/api/activate?email=${ANIMATIONS_EMAIL}" | bash
curl -fsSL "https://animations.dev/api/activate-design-engineering?email=${ANIMATIONS_EMAIL}" | bash

# === Plugin Marketplaces ===
echo "Adding plugin marketplaces..."
claude plugin marketplace add https://github.com/anthropics/claude-plugins 2>/dev/null || true
claude plugin marketplace add https://github.com/somtougeh/somto-dev-toolkit 2>/dev/null || true
claude plugin marketplace add https://github.com/EveryInc/compound-engineering-plugin 2>/dev/null || true

# === Plugins ===
echo "Installing plugins..."
for p in code-review typescript-lsp code-simplifier security-guidance \
         pr-review-toolkit explanatory-output-style learning-output-style \
         somto-dev-toolkit compound-engineering; do
  claude plugin install "$p" 2>/dev/null || true
done

echo ""
echo "Done! Restart Claude Code to load plugins."
